@startuml rename-image-flow
!pragma teoz true

title renameImage - Detailed Flow
note right
  **Audiencia**: Developers tocando lógica de rename
  **Complejidad**: Media (rename + metadata preservation)
end note

actor Consumer
participant "renameImage" as rename
participant "_validatePublicId" as vPid
participant "_validateNameSegment" as vName
participant "_splitPublicId" as split
participant "getCloudinaryClient" as client
participant "uploader.rename" as uploaderRename
participant "api.resource" as apiResource
participant "_normalizeGetImageResult" as normalize
participant "_handleCloudinaryRenameError" as errorHandler

Consumer -> rename: { publicId, newName }

== Validation Phase ==
rename -> vPid: publicId
vPid --> rename: ✓ válido

rename -> vName: newName, 'newName'
vName --> rename: ✓ válido

== Build Target PublicId ==
rename -> split: publicId
split --> rename: { folder, name }
rename -> rename: targetPublicId = folder/newName

rename -> vPid: targetPublicId
vPid --> rename: ✓ válido

== SDK Rename Operation ==
rename -> client: getCloudinaryClient()
client --> rename: cloudinary

rename -> uploaderRename: (publicId, targetPublicId, opts)
alt Success
  uploaderRename --> rename: response
else Error 404
  uploaderRename --> errorHandler: error
  errorHandler --> Consumer: NotFoundError
else Error 409
  uploaderRename --> errorHandler: error
  errorHandler --> Consumer: RenameImageError (conflict)
else Other Error
  uploaderRename --> errorHandler: error
  errorHandler --> Consumer: RenameImageError
end

== Fetch Full Result (Source of Truth) ==
note over rename
  uploader.rename no retorna metadata completa
  Necesitamos api.resource para GetImageResult
end note

rename -> apiResource: (targetPublicId, { resource_type, context })
alt Success
  apiResource --> rename: raw response
  rename -> normalize: (raw, targetPublicId)
  normalize --> rename: GetImageResult
  rename --> Consumer: GetImageResult
else Error 404
  apiResource --> errorHandler: error
  errorHandler --> Consumer: NotFoundError
else Other Error
  apiResource --> errorHandler: error
  errorHandler --> Consumer: FetchImageError
end

note over Consumer
  **Garantías finales**:
  - publicId = targetPublicId
  - metadata preservada
  - Todos los campos validados
end note

@enduml
