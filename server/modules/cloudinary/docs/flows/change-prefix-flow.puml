@startuml change-prefix-flow
!pragma teoz true

title changeImagePrefix - Detailed Flow
note right
  **Audiencia**: Developers tocando lógica de prefijos
  **Complejidad**: Alta (3 modes + cálculo + idempotencia)
end note

actor Consumer
participant "changeImagePrefix" as changePrefix
participant "_validatePublicId" as vPid
participant "_validateNameSegment" as vName
participant "_splitPublicId" as split
participant "renameImage" as rename
participant "getImage" as get

Consumer -> changePrefix: { publicId, prefix, mode }

== Validation Phase ==
changePrefix -> vPid: publicId
vPid --> changePrefix: ✓ válido

alt mode not in [replace, append, prepend]
  changePrefix --> Consumer: ValidationError
end

alt prefix !== undefined
  changePrefix -> vName: prefix, 'prefix'
  vName --> changePrefix: ✓ válido
end

alt mode in [append, prepend] && !prefix
  changePrefix --> Consumer: ValidationError
end

== Calculate New Name ==
changePrefix -> split: publicId
split --> changePrefix: { name }

note over changePrefix
  Separar por '-'
  parts[0] = existingPrefix (si hay)
  parts[1+] = baseName
end note

changePrefix -> changePrefix: parse name structure

alt mode = 'replace'
  alt prefix is empty
    changePrefix -> changePrefix: newName = baseName
  else prefix = existingPrefix
    changePrefix -> changePrefix: newName = name (sin cambio)
  else
    changePrefix -> changePrefix: newName = prefix-baseName
  end
end

alt mode = 'prepend'
  alt name.startsWith(prefix-)
    changePrefix -> changePrefix: newName = name (sin cambio)
  else
    changePrefix -> changePrefix: newName = prefix-name
  end
end

alt mode = 'append'
  alt name.endsWith(-prefix)
    changePrefix -> changePrefix: newName = name (sin cambio)
  else
    changePrefix -> changePrefix: newName = name-prefix
  end
end

== Delegate to Rename or Get ==
alt newName === name (no hay cambio)
  note over changePrefix
    Idempotencia: Si no hay cambio real,
    solo consultamos el recurso existente
  end note
  changePrefix -> get: publicId
  get --> changePrefix: GetImageResult
  changePrefix --> Consumer: GetImageResult
else newName !== name (hay cambio)
  changePrefix -> rename: { publicId, newName }
  rename --> changePrefix: GetImageResult
  changePrefix --> Consumer: GetImageResult
end

note over Consumer
  **Garantías**:
  - Idempotente (no duplica prefijos)
  - Delega en renameImage (metadata preservada)
  - Source of truth = Cloudinary
  - Cálculo local solo para decisión
end note

@enduml
