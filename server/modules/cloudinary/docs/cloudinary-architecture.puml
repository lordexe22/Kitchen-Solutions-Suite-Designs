@startuml cloudinary-architecture

title Cloudinary Module - Internal Architecture
note right
  **Audiencia**: Mantenedores / contribuidores
  **Objetivo**: Extender módulo sin romper principios
  **Actualizado**: 2026-02-06
end note

package "Public Facade" {
  [cloudinary.ts] as facade
  note right of facade
    8 funciones públicas
    Orquestan operaciones
    Delegan en utils
  end note
}

package "Core Utilities" {
  [cloudinary.utils.ts] as utils
  note right of utils
    Validaciones (_validate*)
    Normalizaciones (_normalize*)
    Builders (_build*)
    Error handlers (_handle*)
  end note
}

package "Configuration" {
  [cloudinary.config.ts] as config
  note right of config
    Singleton de cliente
    Validación de env vars
  end note
}

package "Error Classes" {
  [cloudinary.errors.ts] as errors
  note right of errors
    ValidationError
    NotFoundError
    ConfigurationError
    UploadError
    DeleteError
    RenameImageError
    MoveImageError
    ReplaceImageError
    FetchImageError
  end note
}

package "Type Definitions" {
  [cloudinary.types.ts] as types
  note right of types
    ImageSource
    Options
    Params
    Results
    Metadata
  end note
}

package "External SDK" {
  [Cloudinary SDK v2] as sdk
  note right of sdk
    uploader.upload
    uploader.rename
    uploader.destroy
    api.resource
    api.resources
  end note
}

facade --> utils : usa
facade --> config : obtiene cliente
facade --> errors : lanza
facade --> types : define contratos
utils --> errors : lanza
utils --> types : usa
config --> sdk : envuelve
facade --> sdk : llama vía config

note as DesignRules
  **Reglas de diseño**:
  
  1. **Separación de responsabilidades**
     - facade: orquestación
     - utils: lógica reutilizable
     - errors: jerarquía clara
     
  2. **Cloudinary es source of truth**
     - Siempre validar con api.resource
     - No confiar en cálculos locales
     
  3. **Validación temprana**
     - Validar inputs antes de SDK
     - Fallar rápido con ValidationError
     
  4. **Normalización consistente**
     - Todos los returns normalizados
     - GetImageResult para reads
     - *Response para writes
     
  5. **Error handling jerárquico**
     - Errores específicos por operación
     - Context preservado para debugging
     - Re-lanzar errores del módulo
     
  6. **Utils prefijados con _**
     - Funciones internas
     - No exportar en public API
     
  7. **Imports dinámicos en utils**
     - Evitar dependencias circulares
     - require() en vez de import
     
  8. **Metadata en context.custom**
     - No usar tags
     - Serializable (sin functions)
end note

note as ExtensionPoints
  **Puntos de extensión**:
  
  **Nueva función pública**:
  → Agregar en facade (cloudinary.ts)
  → Crear tipos en cloudinary.types.ts
  → Reusar utils existentes
  
  **Nueva validación**:
  → Agregar _validate* en utils
  → Llamar desde facade antes de SDK
  
  **Nuevo tipo de error**:
  → Extender clase base en errors.ts
  → Mapear en _handle* utils
  
  **Nueva normalización**:
  → Agregar _normalize* en utils
  → Aplicar en facade después de SDK
end note

@enduml
